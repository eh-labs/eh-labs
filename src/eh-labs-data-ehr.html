<html><head><link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/lodash-element/lodash.js.html">


</head><body><dom-module id="eh-labs-data-ehr">
  <script>
    Polymer({
      is: 'eh-labs-data-ehr',

      properties:{
        query: {
          type: String,
          readonly: true,
        },
        givenTerms: {
          type: Array,
          value: []
        },

        importantTerms: {
          type: Array,
          notify: true,
          computed:'_calculateTerms(query, givenTerms)'
        },

        exampleEhrs:{
          type: Array,
          notify: true,
          value: [
            'Ms [**Known patient lastname 241**] is a [**Age over 90 2398**] year old woman with past medical history significant for hypertension, severe aortic stenosis, hyperlipidemia, arthroplasty. . Per the patient, she was standing and felt a snap of her right leg and fell to the ground. No head trauma or LOC. She was evaluated by orthopedics and transferred to medicine for optimization of her cardiac status. Review of systems: Ear, Nose, Throat: Dry mouth Cardiovascular: Edema, Orthopnea Respiratory: Dyspnea Flowsheet Data as of [**3294-3-6**] 10:33 PM Vital Signs Hemodynamic monitoring Fluid Balance 24 hours Since [**96**] AM Tmax: 37.5 C (99.5) Tcurrent: 37.5 C (99.5) HR: 102 (93 - 102) bpm BP: 117/54(70) {117/54(70) - 117/54(70)} mmHg RR: 24 (15 - 24) insp/min SpO2: 100% Heart rhythm: ST (Sinus Tachycardia) . -- Clarify She appears comfortable with adequate pain control with prn morphine. Given her tight valvular stenosis, she is high risk for general anesthesia. - would start standing tylenol 1g q8 - continue morphine IV prn for breakthrough - plan for OR tomorrow am per ortho pending optimization of her cardiac function, and improvement in renal function . # CAD: No clear documentation, however given age calcific atherosclerosis is highly likely -- continue statin -- Hold beta blocker for now -- hold aspirin in perioperative period . # ATRIAL FIBRILLATION: In setting of acute pain and peri-op. Will need to monitor as pt with high CHADS score, however in periop period would not be able to have systemic anticoagulation -- Rate control with beta blocker once stable -- If unstable, would use esmolol first, cardiovert last option. . # HTN: Better controlled on floor. Good BP control essential for preventing flash pulmonary edema in setting of AS. - continue metoprolol, as above - continue to monitor BP and consider adding another [**Doctor Last Name **] such as amlodipine 5mg daily if BP sustains above SBP 150s . # Hyperlipidemia - continue simvastatin 40mg PO daily . # FEN/GI: Low sodium diet, replete lytes PRN . # CODE: Confirmed DNR/DNI',
            'Pt is a 75F with a PMHx significant for severe PVD, CAD, DM, and CKD who presented to [**Hospital1 **]-[**Location (un) 1375**] on [**6-25**] after being found down unresponsive at home. She was found to be hypoglycemic to 29 with hypotension and bradycardia. Her hypotension and confusion improved with hydration. She had a positive UA which eventually grew klebsiella, treated initially with levofloxacin. She had a leukocytosis to 18 and a creatinine of 6 up from presumed prior baseline of ~2. On morning of transfer, pt had blood cultures result 3/3 bottles positive for GAS, her antibiotics were switched to vancomycin which was then changed to ceftriaxone. Her blood pressure dropped to the 60s. She was given a bolus of bicarb and transfered to their ICU. After an additional bolus of 500cc she was started on levophed. She was anuric throughout the day. She had a midline placed on right side. She received 80mg IV solumedrol this morning in the setting of low BPs and rare eos in urine. On arrival to the MICU pt was awake but drowsy. She was receiving levophed throughout her transfer. Arrival VS: 96.3 68 102/26 22 97% 2L NC on 0.04mcg/kg/min levophed. On ROS, pt denies pain, lightheadedness, headache, neck pain, sore throat, recent illness or sick contacts, cough, shortness of breath, chest discomfort, heartburn, abd pain, n/v, diarrhea, constipation, dysuria. Is a poor historian regarding how long she has had a rash on her legs. States she has not felt ill and she was brought to the hospital because her daughter came home and found her sleeping. Does complain of feeling very thirsty."',
            'Ms. [**Known patient lastname **] is a G2P0010 26 yo F, now estimated to 10 weeks pregnant. Pt has 4yr hx of IDDM. LMP is not known but was sometime in [**Month (only) **]. On [**3243-11-10**], the patient began feeling achy and congested. She had received a flu shot about 1 week prior. She continued to feel poorly on [**3243-11-11**], and developed hyperemesis. She was seen in the ED (but not admitted) at [**Hospital3 **], where she was given IVF, Reglan and Tylenol and she was found to have a positive pregnancy test. Today, she returned to the ED with worsening of symptoms. She was admitted to the OB service and given IVF and Reglan. Of note, her labwork demonstrates a blood glucose of 160, bicarbonate of 11, beta-hCG of 3373 and ketones in her urine. Her family noted that she was breathing rapidly and was quite somnolent. She appears to be in respiratory distress. . The falling beta-HCG and trans-abdominal ultrasound indicate intra-uterine fetal demise. Medications on Admission: Lantus 65 units qAM Novolog SSI Cortef 3mg qAM, 1mg qHS . Meds on Transfer: Levophed Dopamine Solumedrol 80mg IV Amiodarone load Insulin in D10',
          ]},

        queryData: {
          type: Array,
          notify: true,
          value: [
            { path: 'celiac_disease3/', noQueries: 3, notes:[], results:[] },
            { path: 'celiac_disease4/', noQueries: 4, notes:[], results:[] },
            { path: 'celiac_disease5/', noQueries: 5, notes:[], results:[] },
            { path: 'celiac_disease6/', noQueries: 4, notes:[], results:[] },
            { path: 'crohn_disease1/', noQueries: 4, notes:[], results:[] },
            { path: 'lupus_vulgaris2/', noQueries: 3, notes:[], results:[] },
            { path: 'lyme_disease1/', noQueries: 7, notes:[], results:[] },
            { path: 'multiple_sclerosis1/', noQueries: 4, notes:[], results:[] },
            { path: 'multiple_sclerosis2/', noQueries: 4, notes:[], results:[] },
            { path: 'ulcerative_colitis1/', noQueries: 5, notes:[], results:[] },
            { path: 'ulcerative_colitis2/', noQueries: 3, notes:[], results:[] },
            { path: 'whipple_disease2/', noQueries: 8, notes:[], results:[] },
            ],
        },

      },


      /*
        load example notes and results on first attaching the element
      */
      attached: function(){
        window.temp1 = this

        const promises = this.queryData.map(function(item, dataIndex){
          function getReponseHandler( dataIndex, queryNumber, area ){

            function saveQuery(text){
              const queryPath = 'queryData.' + dataIndex
              const areaPath = queryPath  + '.' + area

              const arr = this.get(areaPath)
              arr[queryNumber-1] = text
              this.set(areaPath, arr)
            }

            return saveQuery
          }

          for (i = 1; i <= item.noQueries; i++) {
            let handler = getReponseHandler(dataIndex, i, 'notes').bind(this)
            let resultHandler = getReponseHandler(dataIndex, i, 'results').bind(this)

            fetch('/results_demo/' + item.path + 'q' + i,  {mode: 'same-origin'})
              .then(res => res.text())
              .then(handler)

            fetch('/results_demo/' + item.path + 'results_' + i + '.txt',  {mode: 'same-origin'})
              .then(res => res.text())
              .then(text => {
                diagnoses = text.split('\n').map((line) => {
                  const [code, diagnose, relevance] = line.split('\t')
                  return {code, diagnose, relevance}
                })

                return Promise.resolve(diagnoses)
              })
              .then(resultHandler)
          }
        }, this)


      },

      /*
        load example notes and results upon request
        index: of ehr in queryData
        noOfQueries: number of notes to load
      */
      loadExampleEhr(index, noOfQueries){

      },

      /*
        Term calculation
        query: long String
      */
      _calculateTerms(query, givenTerms){
        const terms = this.query.notes
          .reduce((r, note) => r + " " + note, '')
          .split(/[\s|\.|,|\!|\?]/)



        return this.query
          ? _.chain(terms)
             .groupBy()
             .map( (val, key) => {
               return {word: key, times: val.length, complexity: key.length}}
               )
             .filter((obj) => obj.complexity > 0)
             .sortBy( 'complexity')
             .takeRight(10)
             .map('word')
             .value()
          : []

      },
    });
  </script>
</dom-module>
</body></html>